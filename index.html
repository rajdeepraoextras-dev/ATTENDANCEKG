<!DOCTYPE html>
<html lang="EN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KHANAGO | ELITE MANAGEMENT</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --PRIMARY: #FF6B00;
            --PRIMARY-DARK: #E65A00;
            --BG-PAGE: #F4F4F7;
            --BG-WHITE: #FFFFFF;
            --BORDER: #E0E0E0;
            --TEXT-MAIN: #1A1A1A;
            --TEXT-DIM: #666666;
            --DANGER: #D32F2F;
            --SUCCESS: #2E7D32;
            --ORANGE-TINT: rgba(255, 107, 0, 0.05);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'CALIBRI', SANS-SERIF; text-transform: uppercase; }
        body { background: var(--BG-PAGE); color: var(--TEXT-MAIN); padding: 40px 20px; min-height: 100vh; }
        .CONTAINER { max-width: 1200px; margin: 0 auto; background: var(--BG-WHITE); border: 1px solid var(--BORDER); border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); overflow: hidden; }

        /* HEADER & TABS */
        header { padding: 40px; border-bottom: 1px solid var(--BORDER); background: var(--BG-WHITE); }
        header h1 { font-size: 2.2rem; letter-spacing: 2px; font-weight: 900; border-left: 6px solid var(--PRIMARY); padding-left: 20px; }
        header p { color: var(--PRIMARY); font-size: 0.85rem; letter-spacing: 5px; margin-top: 5px; padding-left: 20px; font-weight: 700; }
        .TABS { display: flex; gap: 30px; padding: 0 40px; background: #FAFAFA; border-bottom: 1px solid var(--BORDER); }
        .TAB-BUTTON { background: none; border: none; color: var(--TEXT-DIM); padding: 18px 0; cursor: pointer; font-weight: 700; font-size: 0.8rem; letter-spacing: 1.5px; position: relative; }
        .TAB-BUTTON.ACTIVE { color: var(--PRIMARY); }
        .TAB-BUTTON.ACTIVE::AFTER { content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 3px; background: var(--PRIMARY); }

        /* ANALYTICS CARDS */
        .STATS-GRID { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .STAT-CARD { background: var(--BG-WHITE); border: 1px solid var(--BORDER); padding: 25px; border-radius: 8px; text-align: center; transition: 0.3s; }
        .STAT-CARD:hover { border-color: var(--PRIMARY); transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .STAT-LABEL { font-size: 0.75rem; color: var(--TEXT-DIM); font-weight: 800; letter-spacing: 1px; margin-bottom: 10px; }
        .STAT-VALUE { font-size: 2rem; font-weight: 900; color: var(--TEXT-MAIN); }
        .STAT-VALUE.ORANGE { color: var(--PRIMARY); }

        /* CONTENT */
        .TAB-CONTENT { display: none; padding: 40px; animation: FADEIN 0.3s EASE; }
        .TAB-CONTENT.ACTIVE { display: block; }
        h2 { font-size: 1rem; margin-bottom: 25px; letter-spacing: 2px; color: var(--TEXT-DIM); font-weight: 800; }

        /* FORM */
        .FORM-ROW { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        label { display: block; margin-bottom: 8px; font-size: 0.75rem; color: var(--TEXT-MAIN); font-weight: 700; }
        input, select { width: 100%; padding: 12px; border: 1px solid var(--BORDER); border-radius: 4px; font-weight: 600; }
        input:focus { outline: none; border-color: var(--PRIMARY); background: var(--ORANGE-TINT); }

        /* BUTTONS */
        .BTN { background: var(--PRIMARY); color: #FFF; border: none; padding: 15px 35px; font-weight: 900; cursor: pointer; border-radius: 4px; transition: 0.2s; }
        .BTN:hover { background: var(--PRIMARY-DARK); box-shadow: 0 4px 12px rgba(255,107,0,0.2); }
        .BTN-SECONDARY { background: #EEE; color: var(--TEXT-MAIN); }
        .BTN-DANGER { background: #FFF; border: 1px solid var(--DANGER); color: var(--DANGER); }

        /* TABLE */
        .TABLE-WRAPPER { overflow-x: auto; margin-top: 30px; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 15px; background: #F9F9F9; color: var(--TEXT-DIM); border-bottom: 2px solid var(--BORDER); font-size: 0.7rem; }
        td { padding: 15px; border-bottom: 1px solid var(--BORDER); font-size: 0.85rem; font-weight: 600; }
        tr:hover td { background: var(--ORANGE-TINT); }

        .STATUS-BADGE { padding: 4px 10px; font-size: 0.7rem; font-weight: 900; border-radius: 2px; }
        .STATUS-PRESENT { background: #E8F5E9; color: var(--SUCCESS); }
        .STATUS-ABSENT { background: #FFEBEE; color: var(--DANGER); }

        .NOTIFICATION { position: fixed; bottom: 30px; right: 30px; background: var(--TEXT-MAIN); color: #FFF; padding: 15px 30px; font-weight: 700; border-radius: 4px; display: none; z-index: 1000; }
        @keyframes FADEIN { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <div class="CONTAINER">
        <header>
            <h1>KHANAGO</h1>
            <p>ELITE ATTENDANCE SYSTEM</p>
        </header>

        <nav class="TABS">
            <button class="TAB-BUTTON ACTIVE" data-tab="ATTENDANCE">DASHBOARD</button>
            <button class="TAB-BUTTON" data-tab="EMPLOYEES">STAFF DATABASE</button>
        </nav>

        <main>
            <div id="NOTIFICATION" class="NOTIFICATION"></div>

            <div id="ATTENDANCE-TAB" class="TAB-CONTENT ACTIVE">
                
                <div class="STATS-GRID">
                    <div class="STAT-CARD">
                        <div class="STAT-LABEL">TOTAL STAFF LOGGED</div>
                        <div class="STAT-VALUE" id="STAT-TOTAL">0</div>
                    </div>
                    <div class="STAT-CARD" style="border-bottom: 3px solid var(--SUCCESS);">
                        <div class="STAT-LABEL">TOTAL PRESENT</div>
                        <div class="STAT-VALUE ORANGE" id="STAT-PRESENT">0</div>
                    </div>
                    <div class="STAT-CARD" style="border-bottom: 3px solid var(--DANGER);">
                        <div class="STAT-LABEL">TOTAL ABSENT</div>
                        <div class="STAT-VALUE" id="STAT-ABSENT">0</div>
                    </div>
                    <div class="STAT-CARD">
                        <div class="STAT-LABEL">LEAVE / HALF DAY</div>
                        <div class="STAT-VALUE" id="STAT-OTHER">0</div>
                    </div>
                </div>

                <h2>MARK ATTENDANCE</h2>
                <form id="ATTENDANCEFORM">
                    <div class="FORM-ROW">
                        <div>
                            <label>OPERATIVE</label>
                            <select id="EMPLOYEESELECT" required><option value="">SYNCHRONIZING...</option></select>
                        </div>
                        <div>
                            <label>STATUS</label>
                            <select id="STATUS" required onchange="HANDLESTATUSCHANGE()">
                                <option value="PRESENT">PRESENT</option>
                                <option value="ABSENT">ABSENT</option>
                                <option value="HALF-DAY">HALF DAY</option>
                                <option value="ON-LEAVE">ON LEAVE</option>
                            </select>
                        </div>
                        <div><label>TIME IN</label><input type="time" id="LOGINTIME"></div>
                        <div><label>TIME OUT</label><input type="time" id="LOGOUTTIME"></div>
                        <div><label>DATE</label><input type="date" id="ATTDATE" required></div>
                    </div>
                    <button type="submit" class="BTN">AUTHORIZE LOG</button>
                </form>

                <div class="FORM-ROW" style="margin-top: 60px;">
                    <div><label>VIEW HISTORY BY DATE</label><input type="date" id="DATEFILTER"></div>
                </div>

                <div class="TABLE-WRAPPER">
                    <table>
                        <thead>
                            <tr><th>ID</th><th>NAME</th><th>STATUS</th><th>IN</th><th>OUT</th><th>DATE</th></tr>
                        </thead>
                        <tbody id="ATTENDANCETABLEBODY"></tbody>
                    </table>
                </div>
            </div>

            <div id="EMPLOYEES-TAB" class="TAB-CONTENT">
                <h2 id="EMPFORMTITLE">ONBOARD STAFF</h2>
                <form id="EMPLOYEEFORM">
                    <div class="FORM-ROW">
                        <div><label>SERIAL ID</label><input type="text" id="EMPID" placeholder="KH-01" required></div>
                        <div><label>FULL NAME</label><input type="text" id="EMPNAME" placeholder="NAME" required></div>
                        <div>
                            <label>UNIT</label>
                            <select id="POSITION">
                                <option value="RIDER">RIDER</option>
                                <option value="KITCHEN">KITCHEN UNIT</option>
                                <option value="MANAGER">LEAD MANAGER</option>
                            </select>
                        </div>
                        <div><label>CONTACT</label><input type="tel" id="PHONE" required></div>
                    </div>
                    <div style="display:flex; gap:15px;">
                        <button type="submit" id="SAVEEMPBTN" class="BTN">SAVE OPERATIVE</button>
                        <button type="button" id="CANCELEDIT" class="BTN BTN-SECONDARY" style="display:none;">ABORT</button>
                    </div>
                </form>

                <div class="TABLE-WRAPPER">
                    <table>
                        <thead>
                            <tr><th>SERIAL</th><th>NAME</th><th>UNIT</th><th>PHONE</th><th>ACTIONS</th></tr>
                        </thead>
                        <tbody id="EMPLOYEETABLEBODY"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script>
        const SUPABASE_URL = 'https://tyhrahuionsvzyuzdtkr.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR5aHJhaHVpb25zdnp5dXpkdGtyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwNzA4MTcsImV4cCI6MjA4MTY0NjgxN30.ypEmevr3XTuyNtJxUSSqCplAdcru9fkE3q15HOQHrVY';
        const _SUPABASE = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let EMPLOYEES = [];
        let ATTENDANCE = [];
        let EDITMODE = false;
        let EDITID = null;

        document.addEventListener('DOMContentLoaded', async () => {
            INITDATES();
            SETUPTABS();
            await FETCHDATA();
        });

        function INITDATES() {
            const TODAY = new Date().toISOString().split('T')[0];
            document.getElementById('ATTDATE').value = TODAY;
            document.getElementById('DATEFILTER').value = TODAY;
        }

        async function FETCHDATA() {
            const { data: EDATA } = await _SUPABASE.from('employees').select('*').order('name');
            EMPLOYEES = EDATA || [];
            const { data: ADATA } = await _SUPABASE.from('attendance').select('*').order('date', { ascending: false });
            ATTENDANCE = ADATA || [];
            RENDERALL();
        }

        function SETUPTABS() {
            document.querySelectorAll('.TAB-BUTTON').forEach(BTN => {
                BTN.addEventListener('click', () => {
                    document.querySelectorAll('.TAB-BUTTON, .TAB-CONTENT').forEach(EL => EL.classList.remove('ACTIVE'));
                    BTN.classList.add('ACTIVE');
                    document.getElementById(`${BTN.dataset.tab}-TAB`).classList.add('ACTIVE');
                });
            });
        }

        // EMPLOYEE ACTIONS
        document.getElementById('EMPLOYEEFORM').addEventListener('submit', async (E) => {
            E.preventDefault();
            const DATA = {
                id: document.getElementById('EMPID').value.toUpperCase(),
                name: document.getElementById('EMPNAME').value.toUpperCase(),
                position: document.getElementById('POSITION').value.toUpperCase(),
                phone: document.getElementById('PHONE').value
            };
            if (EDITMODE) {
                await _SUPABASE.from('employees').update(DATA).eq('id', EDITID);
                NOTIFY("STAFF MEMBER UPDATED");
            } else {
                const { error } = await _SUPABASE.from('employees').insert([DATA]);
                if (error) return alert("ERROR: SERIAL EXISTS");
                NOTIFY("STAFF MEMBER REGISTERED");
            }
            RESETEMPFORM();
            await FETCHDATA();
        });

        async function DELETEEMPLOYEE(ID) {
            if (confirm("REMOVE THIS OPERATIVE?")) {
                await _SUPABASE.from('employees').delete().eq('id', ID);
                await FETCHDATA();
            }
        }

        function EDITEMPLOYEE(ID) {
            const EMP = EMPLOYEES.find(E => E.id === ID);
            document.getElementById('EMPID').value = EMP.id;
            document.getElementById('EMPNAME').value = EMP.name;
            document.getElementById('POSITION').value = EMP.position;
            document.getElementById('PHONE').value = EMP.phone;
            EDITMODE = true; EDITID = ID;
            document.getElementById('EMPID').disabled = true;
            document.getElementById('CANCELEDIT').style.display = "BLOCK";
            document.getElementById('EMPFORMTITLE').innerText = "MODIFY STAFF MEMBER";
        }

        function RESETEMPFORM() {
            EDITMODE = false; EDITID = null;
            document.getElementById('EMPLOYEEFORM').reset();
            document.getElementById('EMPID').disabled = false;
            document.getElementById('CANCELEDIT').style.display = "NONE";
            document.getElementById('EMPFORMTITLE').innerText = "ONBOARD STAFF";
        }

        // ATTENDANCE ACTIONS
        document.getElementById('ATTENDANCEFORM').addEventListener('submit', async (E) => {
            E.preventDefault();
            const EMPID = document.getElementById('EMPLOYEESELECT').value;
            const EMP = EMPLOYEES.find(E => E.id === EMPID);
            const RECORD = {
                emp_id: EMP.id, name: EMP.name, status: document.getElementById('STATUS').value.toUpperCase(),
                login: document.getElementById('LOGINTIME').value || '--',
                logout: document.getElementById('LOGOUTTIME').value || '--',
                date: document.getElementById('ATTDATE').value
            };
            await _SUPABASE.from('attendance').insert([RECORD]);
            NOTIFY("LOG SAVED SUCCESSFULLY");
            await FETCHDATA();
        });

        function HANDLESTATUSCHANGE() {
            const S = document.getElementById('STATUS').value;
            const OFF = (S === 'ABSENT' || S === 'ON-LEAVE');
            document.getElementById('LOGINTIME').disabled = OFF;
            document.getElementById('LOGOUTTIME').disabled = OFF;
        }

        function RENDERALL() {
            RENDEREMPLOYEES();
            RENDERATTENDANCE();
            const SEL = document.getElementById('EMPLOYEESELECT');
            SEL.innerHTML = '<option value="">CHOOSE STAFF</option>' + 
                EMPLOYEES.map(E => `<option value="${E.id}">${E.name}</option>`).join('');
        }

        function RENDEREMPLOYEES() {
            document.getElementById('EMPLOYEETABLEBODY').innerHTML = EMPLOYEES.map(E => `
                <tr><td>${E.id}</td><td>${E.name}</td><td>${E.position}</td><td>${E.phone}</td>
                <td><button onclick="EDITEMPLOYEE('${E.id}')" class="BTN BTN-SECONDARY" style="padding: 5px 12px; font-size: 0.65rem;">EDIT</button>
                <button onclick="DELETEEMPLOYEE('${E.id}')" class="BTN BTN-DANGER" style="padding: 5px 12px; font-size: 0.65rem;">DEL</button></td></tr>
            `).join('');
        }

        function RENDERATTENDANCE() {
            const F = document.getElementById('DATEFILTER').value;
            const FILT = ATTENDANCE.filter(A => !F || A.date === F);
            
            // UPDATE STATS BASED ON FILTERED DATA
            const TOTAL = FILT.length;
            const PRESENT = FILT.filter(A => A.status === 'PRESENT').length;
            const ABSENT = FILT.filter(A => A.status === 'ABSENT').length;
            const OTHER = TOTAL - PRESENT - ABSENT;

            document.getElementById('STAT-TOTAL').innerText = TOTAL;
            document.getElementById('STAT-PRESENT').innerText = PRESENT;
            document.getElementById('STAT-ABSENT').innerText = ABSENT;
            document.getElementById('STAT-OTHER').innerText = OTHER;

            document.getElementById('ATTENDANCETABLEBODY').innerHTML = FILT.map(A => `
                <tr><td>${A.emp_id}</td><td>${A.name}</td>
                <td><span class="STATUS-BADGE STATUS-${A.status}">${A.status}</span></td>
                <td>${A.login}</td><td>${A.logout}</td><td>${A.date}</td></tr>
            `).join('') || '<tr><td colspan="6" style="text-align:center; padding: 40px; color:#AAA">NO RECORDS FOUND</td></tr>';
        }

        function NOTIFY(M) {
            const N = document.getElementById('NOTIFICATION');
            N.innerText = M; N.style.display = 'BLOCK';
            setTimeout(() => N.style.display = 'NONE', 3000);
        }

        document.getElementById('DATEFILTER').addEventListener('change', RENDERATTENDANCE);
        document.getElementById('CANCELEDIT').addEventListener('click', RESETEMPFORM);
    </script>
</body>
</html>
