<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>खानागो | अटेंडेंस</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --PRIMARY: #FF6B00;
            --BG-PAGE: #F4F6F8;
            --BG-WHITE: #FFFFFF;
            --TEXT-MAIN: #222222;
            --TEXT-LIGHT: #666666;
            --DANGER: #D32F2F;
            --SUCCESS: #2E7D32;
            --BORDER: #DDDDDD;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--BG-PAGE); color: var(--TEXT-MAIN); padding-bottom: 50px; }

        /* HEADER */
        header { background: var(--BG-WHITE); padding: 20px; border-bottom: 1px solid var(--BORDER); text-align: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        header h1 { font-size: 1.5rem; color: var(--PRIMARY); font-weight: 900; letter-spacing: 1px; }
        header p { font-size: 0.8rem; color: var(--TEXT-LIGHT); margin-top: 2px; }

        /* STATS CARDS */
        .STATS-GRID { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 20px; }
        .STAT-CARD { background: #FFF; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid var(--BORDER); box-shadow: 0 2px 4px rgba(0,0,0,0.03); }
        .STAT-LABEL { font-size: 0.75rem; color: var(--TEXT-LIGHT); font-weight: bold; }
        .STAT-VALUE { font-size: 1.5rem; font-weight: 900; color: var(--TEXT-MAIN); margin-top: 5px; }
        .FULL-WIDTH { grid-column: span 2; }

        /* FORM STYLES */
        .CONTAINER { padding: 0 20px; }
        .CARD { background: #FFF; padding: 20px; border-radius: 10px; border: 1px solid var(--BORDER); margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        h2 { font-size: 1.1rem; border-left: 4px solid var(--PRIMARY); padding-left: 10px; margin-bottom: 20px; color: var(--TEXT-MAIN); }

        .INPUT-ROW { margin-bottom: 15px; }
        label { display: block; margin-bottom: 8px; font-size: 0.85rem; font-weight: bold; color: var(--TEXT-LIGHT); }
        input, select { width: 100%; padding: 14px; font-size: 1rem; border: 1px solid #CCC; border-radius: 6px; background: #FAFAFA; appearance: none; }
        input:focus, select:focus { border-color: var(--PRIMARY); outline: none; background: #FFF; }

        /* TIME BUTTONS */
        .TIME-GROUP { position: relative; }
        .NOW-BTN { position: absolute; right: 8px; top: 38px; background: #333; color: #FFF; border: none; padding: 5px 10px; border-radius: 4px; font-size: 0.7rem; }

        /* ACTION BUTTONS */
        .BTN { width: 100%; padding: 16px; border: none; border-radius: 8px; font-size: 1rem; font-weight: 900; cursor: pointer; color: #FFF; background: var(--PRIMARY); margin-top: 10px; box-shadow: 0 4px 6px rgba(255,107,0,0.2); }
        .BTN:active { transform: scale(0.98); }
        .BTN-OUT { background: #333; }
        .BTN-UPDATE { background: #666; }

        /* STATUS BADGES & TEXT */
        .STATUS-MSG { text-align: center; font-size: 0.9rem; font-weight: bold; margin-bottom: 15px; padding: 10px; background: #F9F9F9; border-radius: 4px; border: 1px dashed #CCC; }
        .DOT { height: 10px; width: 10px; background: #CCC; border-radius: 50%; display: inline-block; margin-right: 5px; }
        
        /* TABLE */
        .TABLE-CONTAINER { overflow-x: auto; background: #FFF; border-radius: 8px; border: 1px solid var(--BORDER); }
        table { width: 100%; border-collapse: collapse; min-width: 500px; }
        th { background: #F0F0F0; text-align: left; padding: 12px; font-size: 0.8rem; color: var(--TEXT-LIGHT); }
        td { padding: 15px 12px; border-bottom: 1px solid #EEE; font-size: 0.9rem; font-weight: 600; }
        tr:last-child td { border-bottom: none; }

        .BADGE { padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; }
        .B-PRESENT { background: #E8F5E9; color: var(--SUCCESS); }
        .B-ABSENT { background: #FFEBEE; color: var(--DANGER); }

        /* NOTIFICATION */
        .TOAST { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #333; color: #FFF; padding: 12px 25px; border-radius: 30px; font-size: 0.9rem; display: none; z-index: 999; width: 90%; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
    </style>
</head>
<body>

    <header>
        <h1>खानागो (KHANAGO)</h1>
        <p>डेली हाजिरी सिस्टम</p>
    </header>

    <div id="TOAST" class="TOAST">मैसेज यहाँ आएगा</div>

    <div class="STATS-GRID">
        <div class="STAT-CARD">
            <div class="STAT-LABEL">कुल स्टाफ</div>
            <div class="STAT-VALUE" id="STAT-TOTAL">0</div>
        </div>
        <div class="STAT-CARD">
            <div class="STAT-LABEL">आज उपस्थित</div>
            <div class="STAT-VALUE" id="STAT-PRESENT" style="color: var(--SUCCESS)">0</div>
        </div>
        <div class="STAT-CARD FULL-WIDTH">
            <div class="STAT-LABEL">अनुपस्थित (Absent)</div>
            <div class="STAT-VALUE" id="STAT-ABSENT" style="color: var(--DANGER)">0</div>
        </div>
    </div>

    <div class="CONTAINER">
        <div class="CARD">
            <h2>हाजिरी लगाएं</h2>
            <form id="ATTENDANCEFORM">
                
                <div class="INPUT-ROW">
                    <label>स्टाफ चुनें (Select Staff)</label>
                    <select id="EMPLOYEESELECT" required onchange="CHECK_STATUS()">
                        <option value="">लोड हो रहा है...</option>
                    </select>
                </div>

                <div class="INPUT-ROW">
                    <label>तारीख</label>
                    <input type="date" id="ATTDATE" required onchange="CHECK_STATUS()">
                </div>

                <div class="STATUS-MSG">
                    <span id="STATUS_DOT" class="DOT"></span>
                    <span id="STATUS_TEXT">स्टाफ चुनें</span>
                </div>

                <div class="INPUT-ROW">
                    <label>स्थिति (Status)</label>
                    <select id="STATUS" onchange="HANDLE_MANUAL_STATUS()">
                        <option value="PRESENT">उपस्थित (Present)</option>
                        <option value="ABSENT">अनुपस्थित (Absent)</option>
                        <option value="HALF-DAY">आधा दिन (Half Day)</option>
                        <option value="ON-LEAVE">छुट्टी (Leave)</option>
                    </select>
                </div>

                <div class="STATS-GRID" style="margin: 0 0 15px 0; gap: 15px;">
                    <div class="TIME-GROUP">
                        <label>आने का समय</label>
                        <input type="time" id="IN_TIME">
                        <button type="button" class="NOW-BTN" onclick="SET_NOW('IN_TIME')">अभी</button>
                    </div>
                    <div class="TIME-GROUP">
                        <label>जाने का समय</label>
                        <input type="time" id="OUT_TIME" disabled>
                        <button type="button" class="NOW-BTN" onclick="SET_NOW('OUT_TIME')">अभी</button>
                    </div>
                </div>

                <button type="submit" id="MAIN_BTN" class="BTN">हाजिरी लगाएं (Punch In)</button>
            </form>
        </div>

        <div class="CARD" style="padding: 15px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h2 style="margin:0; border:none; padding:0; font-size:1rem;">आज का रिकॉर्ड</h2>
                <button onclick="FETCH_DATA()" style="background:#EEE; border:none; padding:5px 10px; border-radius:4px; font-weight:bold;">रिफ्रेश</button>
            </div>
            
            <div class="TABLE-CONTAINER">
                <table>
                    <thead>
                        <tr>
                            <th>नाम</th>
                            <th>स्थिति</th>
                            <th>आया</th>
                            <th>गया</th>
                        </tr>
                    </thead>
                    <tbody id="ATT_TABLE_BODY"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // --- सेटिंग्स ---
        const SUPABASE_URL = 'https://tyhrahuionsvzyuzdtkr.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR5aHJhaHVpb25zdnp5dXpkdGtyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwNzA4MTcsImV4cCI6MjA4MTY0NjgxN30.ypEmevr3XTuyNtJxUSSqCplAdcru9fkE3q15HOQHrVY';
        const _SUPABASE = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let STAFF_LIST = [];
        let ATTENDANCE = [];
        let CURRENT_RECORD_ID = null;

        // --- शुरू होने पर ---
        document.addEventListener('DOMContentLoaded', async () => {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('ATTDATE').value = today;
            await FETCH_DATA();
        });

        // --- डाटा लाना ---
        async function FETCH_DATA() {
            // 1. अब हम 'staffs' टेबल से डाटा ला रहे हैं (schema: staff_id, name, position, location)
            let { data: sData } = await _SUPABASE.from('staffs').select('*').order('name');
            STAFF_LIST = sData || [];

            // 2. अटेंडेंस लाना
            const filterDate = document.getElementById('ATTDATE').value;
            let { data: aData } = await _SUPABASE.from('attendance')
                .select('*')
                .order('created_at', { ascending: false });
            
            ATTENDANCE = aData || [];

            RENDER_UI();
            CHECK_STATUS();
        }

        // --- UI दिखाना ---
        function RENDER_UI() {
            // 1. ड्रापडाउन भरना (staff_id और name का उपयोग करके)
            const sel = document.getElementById('EMPLOYEESELECT');
            const savedVal = sel.value;
            sel.innerHTML = '<option value="">स्टाफ का नाम चुनें...</option>' + 
                STAFF_LIST.map(s => `<option value="${s.staff_id}">${s.name} (${s.location})</option>`).join('');
            sel.value = savedVal;

            // 2. अटेंडेंस टेबल (सिर्फ सेलेक्ट की गयी तारीख की)
            const dateVal = document.getElementById('ATTDATE').value;
            const todayLogs = ATTENDANCE.filter(a => a.date === dateVal);

            // स्टेट्स गिनना
            const total = STAFF_LIST.length; 
            const present = todayLogs.filter(a => a.status === 'PRESENT').length;
            const absent = todayLogs.filter(a => a.status === 'ABSENT').length;

            document.getElementById('STAT-TOTAL').innerText = total;
            document.getElementById('STAT-PRESENT').innerText = present;
            document.getElementById('STAT-ABSENT').innerText = absent;

            document.getElementById('ATT_TABLE_BODY').innerHTML = todayLogs.map(a => `
                <tr>
                    <td>
                        <div style="font-weight:bold">${a.name}</div>
                    </td>
                    <td><span class="BADGE ${a.status === 'PRESENT' ? 'B-PRESENT' : 'B-ABSENT'}">${a.status}</span></td>
                    <td>${a.login}</td>
                    <td>${a.logout}</td>
                </tr>
            `).join('') || '<tr><td colspan="4" style="text-align:center; padding:20px; color:#999">कोई रिकॉर्ड नहीं है</td></tr>';
        }

        // --- स्मार्ट लॉजिक (डुप्लीकेट चेक) ---
        function CHECK_STATUS() {
            const empId = document.getElementById('EMPLOYEESELECT').value;
            const date = document.getElementById('ATTDATE').value;
            const btn = document.getElementById('MAIN_BTN');
            const statusText = document.getElementById('STATUS_TEXT');
            const dot = document.getElementById('STATUS_DOT');

            // रीसेट
            if(!CURRENT_RECORD_ID) {
                document.getElementById('IN_TIME').value = '';
                document.getElementById('OUT_TIME').value = '';
            }

            if (!empId) {
                statusText.innerText = "कृपया स्टाफ चुनें";
                dot.style.background = "#CCC";
                btn.style.display = 'none'; 
                return;
            }

            btn.style.display = 'block'; 

            // चेक करें क्या आज एंट्री है? (यहाँ emp_id का मिलान staff_id से होगा)
            const existing = ATTENDANCE.find(a => a.emp_id === empId && a.date === date);

            if (existing) {
                // एंट्री है -> अपडेट मोड
                CURRENT_RECORD_ID = existing.id;
                document.getElementById('STATUS').value = existing.status;
                document.getElementById('IN_TIME').value = existing.login;
                document.getElementById('OUT_TIME').value = existing.logout;

                if (existing.status === 'ABSENT') {
                    statusText.innerText = "आज अनुपस्थित (Absent) है";
                    dot.style.background = "var(--DANGER)";
                    btn.innerText = "रिकॉर्ड सुधारें";
                    btn.className = "BTN BTN-UPDATE";
                } else if (existing.logout === '--' || !existing.logout) {
                    // काम पर है
                    statusText.innerText = "काम चालू है (Working)";
                    dot.style.background = "var(--SUCCESS)";
                    document.getElementById('IN_TIME').disabled = true;
                    document.getElementById('OUT_TIME').disabled = false;
                    btn.innerText = "काम ख़त्म (Punch Out)";
                    btn.className = "BTN BTN-OUT";
                } else {
                    // काम ख़त्म
                    statusText.innerText = "ड्यूटी पूरी हो गयी";
                    dot.style.background = "var(--PRIMARY)";
                    btn.innerText = "रिकॉर्ड सुधारें";
                    btn.className = "BTN BTN-UPDATE";
                }

            } else {
                // नयी एंट्री
                CURRENT_RECORD_ID = null;
                statusText.innerText = "हाजिरी नहीं लगी है";
                dot.style.background = "#CCC";
                
                document.getElementById('STATUS').value = 'PRESENT';
                document.getElementById('IN_TIME').disabled = false;
                document.getElementById('OUT_TIME').disabled = true;
                document.getElementById('IN_TIME').value = '';
                document.getElementById('OUT_TIME').value = '';

                btn.innerText = "हाजिरी लगाएं (Punch In)";
                btn.className = "BTN";
            }
        }

        function HANDLE_MANUAL_STATUS() {
            const s = document.getElementById('STATUS').value;
            if (s === 'ABSENT' || s === 'ON-LEAVE') {
                document.getElementById('IN_TIME').value = '--';
                document.getElementById('OUT_TIME').value = '--';
                document.getElementById('IN_TIME').disabled = true;
                document.getElementById('OUT_TIME').disabled = true;
            } else {
                document.getElementById('IN_TIME').disabled = false;
                if(CURRENT_RECORD_ID && document.getElementById('OUT_TIME').value === '') {
                     // अगर अपडेट कर रहे हैं तो आउट टाइम खोल सकते हैं
                }
            }
        }

        // --- हाजिरी सबमिट ---
        document.getElementById('ATTENDANCEFORM').addEventListener('submit', async (e) => {
            e.preventDefault();
            const staffId = document.getElementById('EMPLOYEESELECT').value;
            
            // Staff table से नाम निकालें
            const staffObj = STAFF_LIST.find(s => s.staff_id === staffId);
            const staffName = staffObj ? staffObj.name : 'Unknown';

            const date = document.getElementById('ATTDATE').value;
            const status = document.getElementById('STATUS').value;
            let inT = document.getElementById('IN_TIME').value;
            let outT = document.getElementById('OUT_TIME').value;

            // डबल चेक (डुप्लीकेट रोकने के लिए)
            const doubleCheck = ATTENDANCE.find(a => a.emp_id === staffId && a.date === date);
            if (!CURRENT_RECORD_ID && doubleCheck) {
                SHOW_TOAST("रुको! इसकी हाजिरी लग चुकी है।");
                await FETCH_DATA();
                return;
            }

            if (status === 'PRESENT' && !inT) inT = GET_TIME_NOW();

            // हम attendance टेबल में emp_id की जगह staff_id भेज रहे हैं
            const payload = {
                emp_id: staffId, 
                name: staffName, 
                status: status,
                login: inT || '--', 
                logout: outT || '--', 
                date: date
            };

            if (CURRENT_RECORD_ID) {
                await _SUPABASE.from('attendance').update(payload).eq('id', CURRENT_RECORD_ID);
                SHOW_TOAST("रिकॉर्ड अपडेट हो गया!");
            } else {
                await _SUPABASE.from('attendance').insert([payload]);
                SHOW_TOAST("हाजिरी लग गयी!");
            }

            await FETCH_DATA();
        });

        // --- छोटे फंक्शन ---
        function SET_NOW(id) { document.getElementById(id).value = GET_TIME_NOW(); }
        function GET_TIME_NOW() { return new Date().toTimeString().substring(0,5); }
        
        function SHOW_TOAST(msg) {
            const t = document.getElementById('TOAST');
            t.innerText = msg; t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 3000);
        }
    </script>
</body>
</html>
