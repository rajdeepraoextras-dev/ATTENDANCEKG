<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Khanago Attendance</title>

<script src="https://cdn.tailwindcss.com"></script>
<script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<style>
body {
  font-family: Calibri, Arial, sans-serif;
  background-color: #f3f4f6;
}
</style>

<script>
tailwind.config = {
  theme: {
    extend: {
      colors: {
        brand: {
          600: '#ea580c',
          700: '#c2410c'
        }
      }
    }
  }
}
</script>
</head>

<body class="text-gray-800">
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect } = React;

const SCRIPT_URL =
"https://script.google.com/macros/s/AKfycbxpGLcnF_rVOYtKwlZFjjvT_v1jM8mP2_KqMttXracLlPO9qeFYfVKi6jlBoQ-KgmYy5Q/exec";

/* ðŸ”’ DATE NORMALIZER (KEY FIX) */
const formatDate = (d) => {
  if (!d) return "";
  const dt = new Date(d);
  if (isNaN(dt)) return String(d).substring(0,10);
  return dt.toISOString().split("T")[0];
};

function App() {
  const [employees, setEmployees] = useState([]);
  const [attendance, setAttendance] = useState([]);
  const [selectedDate, setSelectedDate] = useState(formatDate(new Date()));
  const [loading, setLoading] = useState(true);
  const [submitting, setSubmitting] = useState(false);

  useEffect(() => { loadData(); }, []);

  async function loadData() {
    setLoading(true);
    const res = await fetch(`${SCRIPT_URL}?action=getData`);
    const data = await res.json();

    setEmployees(data.employees || []);

    /* âœ… FIX #1 â€” STRICT employeeId */
    setAttendance((data.attendance || []).map(a => ({
      ...a,
      employeeId: String(a.employeeId).trim(),
      date: formatDate(a.date)
    })));

    setLoading(false);
  }

  /* âœ… FIX #2 â€” DATE MATCHING */
  const todayData = employees.map(emp => {
    const rec = attendance.find(a =>
      String(a.employeeId).trim() === String(emp.id).trim() &&
      formatDate(a.date) === selectedDate
    );

    return {
      ...emp,
      status: rec?.status || "absent",
      checkIn: rec?.checkIn || "",
      checkOut: rec?.checkOut || ""
    };
  });

  function markStatus(id, status) {
    setAttendance(prev => {
      const found = prev.find(a => a.employeeId === id && a.date === selectedDate);
      if (found) {
        return prev.map(a =>
          a.employeeId === id && a.date === selectedDate
            ? { ...a, status }
            : a
        );
      }
      const emp = employees.find(e => e.id === id);
      return [...prev, {
        employeeId: id,
        employeeName: emp.name,
        date: selectedDate,
        status,
        checkIn: "",
        checkOut: ""
      }];
    });
  }

  function updateTime(id, field, value) {
    setAttendance(prev => {
      const found = prev.find(a => a.employeeId === id && a.date === selectedDate);
      if (found) {
        return prev.map(a =>
          a.employeeId === id && a.date === selectedDate
            ? { ...a, [field]: value, status: value ? "present" : a.status }
            : a
        );
      }
      const emp = employees.find(e => e.id === id);
      return [...prev, {
        employeeId: id,
        employeeName: emp.name,
        date: selectedDate,
        status: "present",
        checkIn: field === "checkIn" ? value : "",
        checkOut: field === "checkOut" ? value : ""
      }];
    });
  }

  async function submitAttendance() {
    setSubmitting(true);
    for (const emp of todayData) {
      await fetch(`${SCRIPT_URL}?action=saveAttendance`, {
        method: "POST",
        body: JSON.stringify({
          employeeId: emp.id,
          employeeName: emp.name,
          date: selectedDate,
          status: emp.status,
          checkIn: emp.checkIn,
          checkOut: emp.checkOut
        })
      });
    }
    alert("âœ… Attendance saved");
    setSubmitting(false);
    loadData();
  }

  if (loading) {
    return <div className="text-center mt-20 font-bold">Loading...</div>;
  }

  return (
    <div className="max-w-4xl mx-auto p-4 pb-32">

      <div className="bg-gradient-to-r from-brand-600 to-brand-700 text-white p-6 rounded-2xl shadow-lg text-center">
        <h1 className="text-4xl font-extrabold tracking-widest">KHANAGO</h1>
        <p className="text-sm tracking-widest uppercase">Attendance System</p>
        <input
          type="date"
          value={selectedDate}
          onChange={e => setSelectedDate(e.target.value)}
          className="mt-4 p-2 rounded text-black font-bold"
        />
      </div>

      <div className="mt-6 space-y-4">
        {todayData.map(emp => (
          <div key={emp.id} className="bg-white rounded-xl p-4 shadow-md border">
            <div className="flex justify-between mb-2">
              <div>
                <div className="font-bold text-lg">{emp.name}</div>
                <div className="text-xs text-gray-500 uppercase">{emp.position}</div>
              </div>
              <div className="font-mono text-xs">#{emp.id}</div>
            </div>

            <div className="grid grid-cols-2 gap-3 mb-3">
              <input type="time" value={emp.checkIn}
                onChange={e => updateTime(emp.id, "checkIn", e.target.value)}
                className="border p-2 rounded"/>
              <input type="time" value={emp.checkOut}
                onChange={e => updateTime(emp.id, "checkOut", e.target.value)}
                className="border p-2 rounded"/>
            </div>

            <div className="flex gap-2">
              {["present","absent","leave"].map(s => (
                <button key={s}
                  onClick={() => markStatus(emp.id, s)}
                  className={`flex-1 py-2 rounded text-xs font-bold uppercase
                    ${emp.status===s
                      ? s==="present"?"bg-green-600 text-white"
                        : s==="absent"?"bg-red-600 text-white"
                        :"bg-yellow-500 text-white"
                      :"bg-gray-200"}`}>
                  {s}
                </button>
              ))}
            </div>
          </div>
        ))}
      </div>

      <div className="fixed bottom-6 left-0 right-0 flex justify-center">
        <button
          onClick={submitAttendance}
          disabled={submitting}
          className="bg-green-600 text-white px-12 py-4 rounded-full font-extrabold shadow-xl">
          {submitting ? "Saving..." : "SUBMIT ATTENDANCE"}
        </button>
      </div>

    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>
</body>
</html>
