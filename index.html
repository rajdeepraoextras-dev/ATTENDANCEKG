<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Khanago Attendance</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @font-face { font-family: 'Calibri'; src: local('Calibri'), local('Calibri-Regular'), local('Arial'); }
        body { font-family: 'Calibri', sans-serif; background-color: #f8fafc; }
        .slide-up { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxpGLcnF_rVOYtKwlZFjjvT_v1jM8mP2_KqMttXracLlPO9qeFYfVKi6jlBoQ-KgmYy5Q/exec";

        // Helpers
        const formatDate = (d) => d ? new Date(d).toISOString().split('T')[0] : new Date().toISOString().split('T')[0];
        const getCurrentTime = () => new Date().toLocaleTimeString('en-US', { hour12: false, hour: "2-digit", minute: "2-digit" });

        function App() {
            const [activeTab, setActiveTab] = useState('attendance');
            const [employees, setEmployees] = useState([]);
            const [attendance, setAttendance] = useState([]);
            const [selectedDate, setSelectedDate] = useState(formatDate(new Date()));
            const [loading, setLoading] = useState(true);
            const [notification, setNotification] = useState(null);
            
            // New Employee State
            const [newEmp, setNewEmp] = useState({ id: '', name: '', position: '', mobile: '', workTiming: '' });

            useEffect(() => { fetchData(); }, []);

            // Auto-hide notification
            useEffect(() => {
                if (notification) {
                    const timer = setTimeout(() => setNotification(null), 3000);
                    return () => clearTimeout(timer);
                }
            }, [notification]);

            const fetchData = async () => {
                setLoading(true);
                try {
                    const res = await fetch(`${SCRIPT_URL}?action=getData`);
                    const data = await res.json();
                    
                    if (data.employees) {
                        setEmployees(data.employees.map(e => ({
                            id: String(e.id || e.ID || e.employeeId).trim(),
                            name: e.name || e.Name || e.employeeName,
                            position: e.position || e.Position || '',
                            mobile: e.mobile || e.Mobile || '',
                            workTiming: e.workTiming || e.WorkTiming || ''
                        })).filter(e => e.id));
                    }
                    if (data.attendance) {
                        setAttendance(data.attendance.map(a => ({
                            ...a,
                            employeeId: String(a.employeeId || a.id).trim(),
                            date: formatDate(a.date || a.Date)
                        })));
                    }
                } catch (err) { console.error(err); }
                setLoading(false);
            };

            const markOne = async (emp, status) => {
                const record = {
                    employeeId: emp.id,
                    employeeName: emp.name,
                    date: selectedDate,
                    status: status,
                    checkIn: status === 'present' ? getCurrentTime() : '',
                    checkOut: ''
                };

                // 1. Update UI Instantly (Optimistic)
                setAttendance(prev => [...prev.filter(a => !(a.employeeId === emp.id && a.date === selectedDate)), record]);
                setNotification(`✅ ${emp.name} marked as ${status.toUpperCase()}`);

                // 2. Send to Backend
                try {
                    await fetch(`${SCRIPT_URL}?action=saveAttendance`, {
                        method: "POST", body: JSON.stringify(record)
                    });
                } catch (err) {
                    setNotification("❌ Error saving to cloud");
                }
            };

            const addEmployee = async () => {
                if (!newEmp.id || !newEmp.name) return alert("ID & Name required");
                setEmployees([...employees, { ...newEmp, id: String(newEmp.id).trim() }]);
                setNewEmp({ id: '', name: '', position: '', mobile: '', workTiming: '' });
                await fetch(`${SCRIPT_URL}?action=saveEmployee`, { method: "POST", body: JSON.stringify(newEmp) });
            };

            const deleteEmployee = async (id) => {
                if(!confirm("Delete this employee?")) return;
                setEmployees(prev => prev.filter(e => e.id !== id));
                await fetch(`${SCRIPT_URL}?action=deleteEmployee&id=${id}`);
            };

            // --- FILTER LOGIC ---
            // Completed: Found in attendance array for this date
            const completedList = employees.filter(emp => 
                attendance.some(a => a.employeeId === emp.id && a.date === selectedDate)
            ).map(emp => {
                const record = attendance.find(a => a.employeeId === emp.id && a.date === selectedDate);
                return { ...emp, ...record };
            });

            // Pending: Not found in attendance array for this date
            const pendingList = employees.filter(emp => 
                !attendance.some(a => a.employeeId === emp.id && a.date === selectedDate)
            );

            return (
                <div className="min-h-screen pb-20 relative">
                    {/* Notification Toast */}
                    {notification && (
                        <div className="fixed top-4 left-1/2 transform -translate-x-1/2 z-50 bg-gray-800 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-2 slide-up">
                            {notification}
                        </div>
                    )}

                    {/* Header */}
                    <div className="bg-orange-600 text-white p-6 shadow-md rounded-b-3xl mb-6">
                        <h1 className="text-3xl font-extrabold text-center tracking-widest uppercase">KHANAGO</h1>
                        <p className="text-center text-orange-100 text-sm">ATTENDANCE SYSTEM</p>
                        
                        {/* Tabs */}
                        <div className="flex justify-center mt-6 gap-2">
                             <button onClick={() => setActiveTab('attendance')} className={`px-6 py-2 rounded-full text-sm font-bold transition-all ${activeTab === 'attendance' ? 'bg-white text-orange-600 shadow-lg' : 'bg-orange-700 text-orange-200'}`}>ATTENDANCE</button>
                             <button onClick={() => setActiveTab('employees')} className={`px-6 py-2 rounded-full text-sm font-bold transition-all ${activeTab === 'employees' ? 'bg-white text-orange-600 shadow-lg' : 'bg-orange-700 text-orange-200'}`}>EMPLOYEES</button>
                        </div>
                    </div>

                    <div className="max-w-3xl mx-auto px-4">
                        {loading ? (
                            <div className="text-center py-20 text-gray-500 font-bold animate-pulse">LOADING DATA...</div>
                        ) : activeTab === 'attendance' ? (
                            <div>
                                {/* Date Picker */}
                                <div className="mb-6 bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center">
                                    <span className="text-gray-500 font-bold text-sm uppercase">Date:</span>
                                    <input type="date" value={selectedDate} onChange={e => setSelectedDate(e.target.value)} className="font-bold text-gray-800 bg-transparent outline-none text-right" />
                                </div>

                                {/* SECTION 1: PENDING (Mark These) */}
                                {pendingList.length > 0 && (
                                    <div className="mb-8">
                                        <h2 className="text-sm font-extrabold text-gray-400 uppercase tracking-wider mb-3">Pending ({pendingList.length})</h2>
                                        <div className="space-y-3">
                                            {pendingList.map(emp => (
                                                <div key={emp.id} className="bg-white p-4 rounded-xl shadow-sm border border-gray-200 flex flex-col sm:flex-row justify-between items-center gap-4">
                                                    <div className="text-center sm:text-left">
                                                        <div className="font-bold text-lg text-gray-800">{emp.name}</div>
                                                        <div className="text-xs text-gray-400 font-mono">{emp.id} • {emp.position}</div>
                                                    </div>
                                                    <div className="flex gap-2 w-full sm:w-auto">
                                                        <button onClick={() => markOne(emp, 'present')} className="flex-1 sm:flex-none bg-green-100 text-green-700 hover:bg-green-600 hover:text-white px-4 py-2 rounded-lg font-bold text-sm transition-colors">PRESENT</button>
                                                        <button onClick={() => markOne(emp, 'absent')} className="flex-1 sm:flex-none bg-red-100 text-red-700 hover:bg-red-600 hover:text-white px-4 py-2 rounded-lg font-bold text-sm transition-colors">ABSENT</button>
                                                        <button onClick={() => markOne(emp, 'leave')} className="flex-1 sm:flex-none bg-yellow-100 text-yellow-700 hover:bg-yellow-500 hover:text-white px-4 py-2 rounded-lg font-bold text-sm transition-colors">LEAVE</button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}

                                {/* SECTION 2: COMPLETED (Log) */}
                                <div>
                                    <h2 className="text-sm font-extrabold text-gray-400 uppercase tracking-wider mb-3">Today's Entries ({completedList.length})</h2>
                                    {completedList.length === 0 ? (
                                        <div className="text-center py-8 text-gray-400 text-sm">No entries yet for today.</div>
                                    ) : (
                                        <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                                            <table className="w-full text-sm text-left">
                                                <thead className="bg-gray-50 text-gray-500 uppercase font-bold">
                                                    <tr>
                                                        <th className="px-4 py-3">Name</th>
                                                        <th className="px-4 py-3">Status</th>
                                                        <th className="px-4 py-3 text-right">Time</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y divide-gray-100">
                                                    {completedList.map(emp => (
                                                        <tr key={emp.id} className="hover:bg-gray-50">
                                                            <td className="px-4 py-3 font-medium text-gray-800">{emp.name}</td>
                                                            <td className="px-4 py-3">
                                                                <span className={`px-2 py-1 rounded text-xs font-bold uppercase ${
                                                                    emp.status === 'present' ? 'bg-green-100 text-green-700' : 
                                                                    emp.status === 'absent' ? 'bg-red-100 text-red-700' : 'bg-yellow-100 text-yellow-700'
                                                                }`}>
                                                                    {emp.status}
                                                                </span>
                                                            </td>
                                                            <td className="px-4 py-3 text-right text-gray-500 font-mono">{emp.checkIn || '-'}</td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    )}
                                </div>
                            </div>
                        ) : (
                            <div className="space-y-6">
                                {/* Add Employee */}
                                <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                                    <h2 className="font-bold text-gray-800 mb-4 uppercase">Add Employee</h2>
                                    <div className="grid gap-3">
                                        <input placeholder="ID (e.g. 001)" value={newEmp.id} onChange={e => setNewEmp({...newEmp, id: e.target.value})} className="border p-2 rounded" />
                                        <input placeholder="Name" value={newEmp.name} onChange={e => setNewEmp({...newEmp, name: e.target.value})} className="border p-2 rounded" />
                                        <input placeholder="Position" value={newEmp.position} onChange={e => setNewEmp({...newEmp, position: e.target.value})} className="border p-2 rounded" />
                                        <button onClick={addEmployee} className="bg-orange-600 text-white font-bold py-3 rounded mt-2 hover:bg-orange-700">SAVE</button>
                                    </div>
                                </div>

                                {/* Employee List */}
                                <div className="space-y-3">
                                    {employees.map(emp => (
                                        <div key={emp.id} className="bg-white p-4 rounded-xl shadow-sm border border-gray-200 flex justify-between items-center">
                                            <div>
                                                <div className="font-bold text-gray-800">{emp.name}</div>
                                                <div className="text-xs text-gray-500 font-mono">#{emp.id} • {emp.position}</div>
                                            </div>
                                            <button onClick={() => deleteEmployee(emp.id)} className="text-red-400 hover:text-red-600">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                                            </button>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
